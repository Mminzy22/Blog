{% capture tocWorkspace %}
    {% comment %}
    목차를 생성하는 전체 HTML을 저장하기 위한 변수 `tocWorkspace`를 정의합니다.
    {% endcomment %}

    {% comment %}
    라이선스와 사용 권한에 대한 설명입니다. 이 코드는 Apache 2.0 라이선스를 따르며 자유롭게 사용이 가능합니다.
    {% endcomment %}
    {% comment %}
        Copyright (c) 2017 Vladimir "allejo" Jimenez

        Permission is hereby granted, free of charge, to any person
        obtaining a copy of this software and associated documentation
        files (the "Software"), to deal in the Software without
        restriction, including without limitation the rights to use,
        copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the
        Software is furnished to do so, subject to the following
        conditions:

        The above copyright notice and this permission notice shall be
        included in all copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
        EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
        OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
        NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
        HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
        WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
        FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
        OTHER DEALINGS IN THE SOFTWARE.
    {% endcomment %}

    {% comment %}
    이 코드의 버전 정보와 GitHub 저장소 링크를 제공합니다.
    {% endcomment %}
    {% comment %}
        Version 1.1.0
        https://github.com/allejo/jekyll-toc
    {% endcomment %}

    {% comment %}
    코드 사용 방법:
    아래와 같이 `include` 태그를 사용해 이 파일을 호출하여 목차를 생성합니다.
    - `html`: 목차를 생성할 HTML 콘텐츠
    - `sanitize`: 헤더에서 HTML을 제거할지 여부
    - `class`: 목차에 적용할 CSS 클래스
    - `id`: 목차에 적용할 HTML ID
    - `h_min`: 최소 포함 헤더 레벨 (예: h2)
    - `h_max`: 최대 포함 헤더 레벨 (예: h3)
    {% endcomment %}
    {% comment %}
        Usage:
        {% include toc.html html=content sanitize=true class="toc" id="page-toc" h_min=2 h_max=3 %}
    {% endcomment %}

    {% comment %}
    `newline` 변수를 정의합니다. 불필요한 공백을 제거하고 줄 바꿈을 유지하기 위한 처리입니다.
    {% endcomment %}
    {% capture newline %}
    {% endcapture %}
    {% assign newline = newline | rstrip %} <!-- 줄 바꿈만 유지하고 공백을 제거합니다 -->

    {% comment %}
    향후 사용될 `deprecation_warnings` 변수는 더 이상 사용되지 않는 옵션에 대한 경고 메시지를 저장합니다.
    {% endcomment %}
    {% capture deprecation_warnings %}{% endcapture %}

    {% comment %}
    `baseurl` 옵션이 설정되어 있으면, 해당 옵션이 더 이상 사용되지 않는다는 경고 메시지를 `deprecation_warnings`에 추가합니다.
    {% endcomment %}
    {% if include.baseurl %}
        {% capture deprecation_warnings %}{{ deprecation_warnings }}<!-- jekyll-toc :: "baseurl" has been deprecated, use "base_url" instead -->{{ newline }}{% endcapture %}
    {% endif %}

    {% comment %}
    `skipNoIDs` 옵션이 설정되어 있으면, 해당 옵션이 더 이상 사용되지 않는다는 경고 메시지를 `deprecation_warnings`에 추가합니다.
    {% endcomment %}
    {% if include.skipNoIDs %}
        {% capture deprecation_warnings %}{{ deprecation_warnings }}<!-- jekyll-toc :: "skipNoIDs" has been deprecated, use "skip_no_ids" instead -->{{ newline }}{% endcapture %}
    {% endif %}

    {% comment %}
    `jekyll_toc` 변수는 목차 HTML을 생성하기 위한 기본 저장 공간으로 초기화됩니다.
    {% endcomment %}
    {% capture jekyll_toc %}{% endcapture %}

    {% comment %}
    다음은 목차 생성을 위한 다양한 매개변수를 설정하는 과정입니다:
    - `orderedList`: 번호형 리스트 여부
    - `baseURL`: 링크의 기본 URL
    - `skipNoIDs`: ID가 없는 헤더를 건너뛸지 여부
    - `minHeader`: 포함할 최소 헤더 레벨
    - `maxHeader`: 포함할 최대 헤더 레벨
    - `nodes`: HTML 콘텐츠를 `<h>` 태그 기준으로 나눈 배열
    {% endcomment %}
    {% assign orderedList = include.ordered | default: false %}
    {% assign baseURL = include.base_url | default: include.baseurl | default: '' %}
    {% assign skipNoIDs = include.skip_no_ids | default: include.skipNoIDs | default: false %}
    {% assign minHeader = include.h_min | default: 1 %}
    {% assign maxHeader = include.h_max | default: 6 %}
    {% assign nodes = include.html | strip | split: '<h' %}

    {% comment %}
    `firstHeader`와 `currLevel`은 목차 생성 상태를 추적하기 위한 변수입니다:
    - `firstHeader`: 첫 번째 헤더가 처리되었는지 여부
    - `currLevel`: 현재 처리 중인 헤더의 레벨
    - `lastLevel`: 이전에 처리된 헤더의 레벨
    {% endcomment %}
    {% assign firstHeader = true %}
    {% assign currLevel = 0 %}
    {% assign lastLevel = 0 %}
{% endcapture %}

{% capture listModifier %}
{% if orderedList %}
    ol
{% else %}
    ul
{% endif %}
{% endcapture %}
{% comment %}
`listModifier`는 생성할 목차가 순서 있는 리스트(`<ol>`)인지, 순서 없는 리스트(`<ul>`)인지 결정합니다.
- `orderedList`가 참이면 `<ol>`로 설정
- 그렇지 않으면 기본값인 `<ul>`로 설정
{% endcomment %}

{% for node in nodes %}
{% if node == "" %}
    {% continue %}
{% endif %}
{% comment %}
`nodes` 배열을 반복 처리하여 각 헤더 태그를 분석합니다.
- 비어 있는 노드는 건너뜁니다 (`{% continue %}`).
{% endcomment %}

{% assign currLevel = node | replace: '"', '' | slice: 0, 1 | times: 1 %}
{% comment %}
`currLevel`은 현재 처리 중인 노드의 헤더 레벨을 계산합니다.
- `<h2>` 같은 태그에서 숫자 부분만 추출 (예: `2`)
- 레벨을 정수로 변환하여 계산 가능하도록 처리합니다.
{% endcomment %}

{% if currLevel < minHeader or currLevel > maxHeader %}
    {% continue %}
{% endif %}
{% comment %}
현재 헤더 레벨이 설정된 최소(`minHeader`) 또는 최대(`maxHeader`) 범위를 벗어나면 무시합니다.
{% endcomment %}

{% assign _workspace = node | split: '</h' %}
{% comment %}
`node`를 `</h>` 태그를 기준으로 분리하여 헤더 콘텐츠를 `_workspace`에 저장합니다.
- 예: `<h2 id="example">Title</h2>` → `["<h2 id=\"example\">Title", "2>"]`
{% endcomment %}

{% assign _idWorkspace = _workspace[0] | split: 'id="' %}
{% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
{% assign htmlID = _idWorkspace[0] %}
{% comment %}
헤더 태그에서 `id` 속성을 추출하여 `htmlID`에 저장합니다.
- 예: `<h2 id="example">` → `example`
{% endcomment %}

{% assign _classWorkspace = _workspace[0] | split: 'class="' %}
{% assign _classWorkspace = _classWorkspace[1] | split: '"' %}
{% assign htmlClass = _classWorkspace[0] %}
{% comment %}
헤더 태그에서 `class` 속성을 추출하여 `htmlClass`에 저장합니다.
- 예: `<h2 class="no_toc">` → `no_toc`
{% endcomment %}

{% if htmlClass contains "no_toc" %}
    {% continue %}
{% endif %}
{% comment %}
`class` 속성에 "no_toc"이 포함된 헤더는 목차에서 제외합니다.
{% endcomment %}

{% if firstHeader %}
    {% assign minHeader = currLevel %}
{% endif %}
{% comment %}
첫 번째 헤더가 처리될 때, 그 헤더의 레벨을 `minHeader`로 설정하여 추후 처리를 조정합니다.
{% endcomment %}

{% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
{% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}
{% comment %}
헤더 태그에서 HTML 속성을 제거하고 텍스트 콘텐츠만 추출하여 `header`에 저장합니다.
- 예: `<h2 id="example">Title</h2>` → `Title`
{% endcomment %}

{% if include.item_class and include.item_class != blank %}
    {% capture listItemClass %}
        class="{{ include.item_class | replace: '%level%', currLevel | split: '.' | join: ' ' }}"
    {% endcapture %}
{% endif %}
{% comment %}
`include.item_class`가 설정된 경우, 각 리스트 아이템에 지정된 CSS 클래스를 추가합니다.
- `%level%`은 현재 헤더 레벨로 대체됩니다.
- 예: `class="heading-level-2"`
{% endcomment %}

{% if include.submenu_class and include.submenu_class != blank %}
    {% assign subMenuLevel = currLevel | minus: 1 %}
    {% capture subMenuClass %}
        class="{{ include.submenu_class | replace: '%level%', subMenuLevel | split: '.' | join: ' ' }}"
    {% endcapture %}
{% endif %}
{% comment %}
`include.submenu_class`가 설정된 경우, 서브메뉴의 리스트에 지정된 CSS 클래스를 추가합니다.
- `%level%`은 현재 서브메뉴 헤더 레벨로 대체됩니다.
- 예: `class="submenu-level-1"`
{% endcomment %}

{% capture anchorBody %}
    {% if include.sanitize %}
        {{ header | strip_html }}
    {% else %}
        {{ header }}
    {% endif %}
{% endcapture %}
{% comment %}
헤더의 내용을 앵커 텍스트로 설정합니다.
- `include.sanitize`가 참이면 HTML 태그를 제거한 텍스트만 사용
- 그렇지 않으면 원래의 헤더 콘텐츠를 그대로 사용
{% endcomment %}

{% if htmlID %}
    {% capture anchorAttributes %}
        href="{% if baseURL %}{{ baseURL }}{% endif %}#{{ htmlID }}"
    {% endcapture %}
    {% if include.anchor_class %}
        {% capture anchorAttributes %}
            {{ anchorAttributes }} class="{{ include.anchor_class | split: '.' | join: ' ' }}"
        {% endcapture %}
    {% endif %}
    {% capture listItem %}
        <a{{ anchorAttributes }}>{{ anchorBody }}</a>
    {% endcapture %}
{% elsif skipNoIDs == true %}
    {% continue %}
{% else %}
    {% capture listItem %}{{ anchorBody }}{% endcapture %}
{% endif %}
{% comment %}
- 헤더에 `id`가 있을 경우: 링크를 생성 (`<a href="#id">`)
- `id`가 없고 `skipNoIDs`가 참일 경우: 헤더를 건너뜀
- `id`가 없을 경우: 텍스트만 출력
- `include.anchor_class`가 설정된 경우: 앵커 태그에 추가 클래스 설정
{% endcomment %}

{% if currLevel > lastLevel %}
{% capture jekyll_toc %}
    {{ jekyll_toc }}<{{ listModifier }}{{ subMenuClass }}>
{% endcapture %}
{% elsif currLevel < lastLevel %}
{% assign repeatCount = lastLevel | minus: currLevel %}
{% for i in (1..repeatCount) %}
    {% capture jekyll_toc %}
        {{ jekyll_toc }}</li></{{ listModifier }}>
    {% endcapture %}
{% endfor %}
{% capture jekyll_toc %}
    {{ jekyll_toc }}</li>
{% endcapture %}
{% else %}
{% capture jekyll_toc %}
    {{ jekyll_toc }}</li>
{% endcapture %}
{% endif %}
{% comment %}
현재 헤더 레벨(currLevel)과 이전 헤더 레벨(lastLevel)을 비교하여 다음을 처리:
1. **레벨 증가 (중첩):**
- 새 `<ul>` 또는 `<ol>` 태그를 열어 서브 리스트를 생성.
2. **레벨 감소 (종료):**
- 차이만큼의 `<ul>` 또는 `<ol>` 태그를 닫음.
3. **같은 레벨:**
- 단순히 현재 `<li>`를 닫고 새 항목을 추가.
{% endcomment %}

{% capture jekyll_toc %}
{{ jekyll_toc }}<li{{ listItemClass }}>{{ listItem }}
{% endcapture %}
{% comment %}
현재 헤더 내용을 기반으로 `<li>` 태그를 생성하여 목차에 추가.
- `listItemClass`가 설정된 경우, 해당 클래스가 포함됨.
{% endcomment %}

{% assign lastLevel = currLevel %}
{% assign firstHeader = false %}
{% comment %}
`lastLevel`을 현재 헤더 레벨로 업데이트하여 다음 항목 처리를 준비.
`firstHeader`를 `false`로 설정해 첫 번째 헤더 처리를 종료.
{% endcomment %}
{% endfor %}

{% assign repeatCount = minHeader | minus: 1 %}
{% assign repeatCount = lastLevel | minus: repeatCount %}
{% for i in (1..repeatCount) %}
    {% capture jekyll_toc %}
        {{ jekyll_toc }}</li></{{ listModifier }}>
    {% endcapture %}
{% endfor %}
{% comment %}
남아 있는 열린 `<ul>` 또는 `<ol>` 태그를 닫기 위한 반복문입니다.
- `repeatCount`는 열린 태그의 개수를 계산.
- 각 반복에서 리스트 항목(`</li>`)과 리스트 태그(`</ul>` 또는 `</ol>`)를 닫습니다.
{% endcomment %}

{% if jekyll_toc != '' %}
    {% assign rootAttributes = '' %}
    {% if include.class and include.class != blank %}
        {% capture rootAttributes %}
            class="{{ include.class | split: '.' | join: ' ' }}"
        {% endcapture %}
    {% endif %}
    {% comment %}
    최상위 리스트에 적용할 HTML 속성 설정.
    - `include.class`가 설정되면 해당 CSS 클래스를 최상위 리스트에 추가.
    {% endcomment %}

    {% if include.id and include.id != blank %}
        {% capture rootAttributes %}
            {{ rootAttributes }} id="{{ include.id }}"
        {% endcapture %}
    {% endif %}
    {% comment %}
    최상위 리스트에 `id` 속성을 추가.
    - `include.id`가 설정된 경우에만 적용됩니다.
    {% endcomment %}

    {% if rootAttributes %}
        {% assign nodes = jekyll_toc | split: '>' %}
        {% capture jekyll_toc %}
            <{{ listModifier }}{{ rootAttributes }}>
            {{ nodes | shift | join: '>' }}
        {% endcapture %}
    {% endif %}
    {% comment %}
    최상위 리스트를 구성하는 HTML 태그를 생성합니다.
    - `listModifier`에 따라 `<ul>` 또는 `<ol>`로 설정.
    - `rootAttributes`에는 클래스나 ID 같은 추가 속성이 포함됩니다.
    {% endcomment %}
{% endif %}
{% endcapture %}
{% assign tocWorkspace = '' %}
{{ deprecation_warnings }}
{{ jekyll_toc }}
{% comment %}
최종적으로 생성된 목차를 `jekyll_toc` 변수에 저장하고 출력.
- 이전에 처리된 모든 항목과 속성을 조합한 결과물입니다.
{% endcomment %}
